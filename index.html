import React, { useState, useEffect } from 'react';
import { Sun, Moon, Plus, Minus, Check, X, RotateCcw, Trophy, Star } from 'lucide-react';

const MerolaWebsite = () => {
  const [currentPage, setCurrentPage] = useState(0);
  const [userAnswers, setUserAnswers] = useState({});
  const [isDarkMode, setIsDarkMode] = useState(false);
  const [fontSize, setFontSize] = useState(20);
  const [toast, setToast] = useState({ visible: false, message: '', isCorrect: false });

  // Comprehensive Exam Data from all 17 PDF Pages
  const examData = [
    {
      title: "Page 1: Antonyms",
      instr: "Choose the word that means the opposite of the underlined word.",
      qs: [
        { q: "1. a <u>problem</u>", opts: ["solution", "worry", "math", "sentence"], c: 0 },
        { q: "2. was <u>loose</u>", opts: ["tight", "large", "big", "win"], c: 0 },
        { q: "3. a <u>question</u>", opts: ["word", "poem", "answer", "talk"], c: 2 },
        { q: "4. was <u>fact</u>", opts: ["true", "real", "fiction", "scary"], c: 2 },
        { q: "5. was <u>straight</u>", opts: ["bent", "tall", "narrow", "long"], c: 0 },
        { q: "6. to <u>create</u>", opts: ["make", "build", "destroy", "draw"], c: 2 },
        { q: "7. was <u>shiny</u>", opts: ["dull", "bright", "pretty", "ugly"], c: 0 },
        { q: "8. to <u>listen</u>", opts: ["hear", "ignore", "touch", "eat"], c: 1 }
      ]
    },
    {
      title: "Page 2: Homographs",
      instr: "Choose the word that correctly completes BOTH sentences.",
      qs: [
        { q: "1. She counted all the ___ in her purse.<br>2. He will ___ clothes before practice.", opts: ["coins", "change", "buy", "money"], c: 1 },
        { q: "1. I will ___ a movie before bed.<br>2. Use your ___ to tell the time.", opts: ["watch", "clock", "see", "rent"], c: 0 },
        { q: "1. If it gets too hot, turn on the ___.<br>2. I am a big ___ of the basketball team.", opts: ["fan", "air", "player", "water"], c: 0 },
        { q: "1. Don't forget to ___ your bag.<br>2. Buy a ___ of gum at the store.", opts: ["stick", "pack", "bring", "use"], c: 1 },
        { q: "1. She ___ school every day at 3:00.<br>2. In the fall, you should rake the ___.", opts: ["grass", "leaves", "visits", "flowers"], c: 1 },
        { q: "1. We took a ___ to the fair.<br>2. You can ___ your dog to do tricks.", opts: ["car", "teach", "train", "bus"], c: 2 },
        { q: "1. In science class, we learned about ___.<br>2. Floss the ___ between your teeth.", opts: ["plants", "letter", "water", "space"], c: 3 },
        { q: "1. Don't ___ in front of others in line.<br>2. ___ the paper into four squares.", opts: ["tear", "rip", "cut", "hit"], c: 2 }
      ]
    },
    {
      title: "Page 3: Prefixes",
      instr: "For numbers 1-4, find the word with ONLY the prefix underlined. For 5-8, match the definition.",
      qs: [
        { q: "1. Underlined correctly:", opts: ["<u>un</u>fair", "disappear", "safely", "misplace"], c: 0 },
        { q: "2. Underlined correctly:", opts: ["dislike", "helpless", "<u>re</u>wind", "unhappy"], c: 2 },
        { q: "3. Underlined correctly:", opts: ["softly", "<u>pre</u>heat", "premade", "unload"], c: 1 },
        { q: "4. Underlined correctly:", opts: ["<u>re</u>make", "dislike", "playful", "kindness"], c: 0 },
        { q: "5. tie again:", opts: ["retie", "untie", "distie", "mistie"], c: 0 },
        { q: "6. spell wrong:", opts: ["unspell", "misspell", "prespell", "disspell"], c: 1 },
        { q: "7. to not agree:", opts: ["unagree", "reagree", "misagree", "disagree"], c: 3 },
        { q: "8. not even:", opts: ["reeven", "diseven", "miseven", "uneven"], c: 3 }
      ]
    },
    {
      title: "Page 4: Suffixes",
      instr: "For numbers 1-4, find the word with ONLY the suffix underlined. For 5-8, match the definition.",
      qs: [
        { q: "1. Underlined correctly:", opts: ["friendly", "worth<u>less</u>", "undo", "replay"], c: 1 },
        { q: "2. Underlined correctly:", opts: ["helpless", "weak<u>ness</u>", "displease", "wildly"], c: 1 },
        { q: "3. Underlined correctly:", opts: ["mistake", "harmless", "help<u>ful</u>", "redo"], c: 2 },
        { q: "4. Underlined correctly:", opts: ["teach<u>er</u>", "painter", "badly", "careful"], c: 0 },
        { q: "5. without a home:", opts: ["homeness", "homeful", "homeless", "homely"], c: 2 },
        { q: "6. full of color:", opts: ["colorly", "colorful", "colorness", "colorless"], c: 1 },
        { q: "7. in a quick way:", opts: ["quickless", "quickly", "quickful", "quicker"], c: 1 },
        { q: "8. one who leads:", opts: ["leader", "leadless", "leadly", "leadful"], c: 0 }
      ]
    },
    {
      title: "Page 5: Phonics Auditory",
      instr: "Listen for beginning, ending, and middle sounds.",
      qs: [
        { q: "1. Same beginning sound as <b>advert</b>:", opts: ["drop", "door", "dig", "school"], c: 1 },
        { q: "2. Same beginning sound as <b>shake</b>:", opts: ["slip", "shop", "ready", "door"], c: 1 },
        { q: "3. Same ending sound as <b>bread</b>:", opts: ["ready", "door", "lead", "check"], c: 2 },
        { q: "4. Same ending sound as <b>luck</b>:", opts: ["check", "lunch", "camp", "school"], c: 0 },
        { q: "5. <b>chart</b> (same middle sound):", opts: ["past", "brain", "tray", "farm"], c: 3 },
        { q: "6. <b>feet</b> (same middle sound):", opts: ["met", "them", "treat", "there"], c: 2 },
        { q: "7. Choose word that means same (<u>fast</u>):", opts: ["slow", "race", "quick", "run"], c: 2 },
        { q: "8. Choose word that means opposite (<u>outside</u>):", opts: ["under", "playing", "next", "inside"], c: 3 }
      ]
    },
    {
      title: "Page 6: Test Practice",
      instr: "Complete the sentences and find suffixes.",
      qs: [
        { q: "9. Please ___ the papers on my desk. / I have never been to that ___.", opts: ["put", "place", "school", "lay"], c: 1 },
        { q: "10. Turn ___ at the stop sign. / I hope I get answers ___ on test.", opts: ["left", "correct", "right", "around"], c: 2 },
        { q: "11. Only suffix underlined:", opts: ["illness", "hope<u>ful</u>", "misplace", "beautiful"], c: 1 },
        { q: "12. Study for the math ___ tomorrow:", opts: ["book", "test", "paper", "homework"], c: 1 },
        { q: "13. Don't want to get questions ___:", opts: ["right", "answers", "wrong", "grade"], c: 2 }
      ]
    },
    {
      title: "Pages 7-8: Penguins",
      passage: "Most penguins live in a land of snow and ice. They cannot fly because their body is too heavy. They use their flat, stiff wings as flippers to swim swiftly.",
      qs: [
        { q: "1. Which sentence DOES NOT tell how penguins move?", opts: ["waddle land", "slide on bellies", "make nest of pebbles", "webbed feet"], c: 2 },
        { q: "2. Meaning of <b>swiftly</b>:", opts: ["carefully", "quickly", "slowly", "safely"], c: 1 },
        { q: "3. <b>Krill</b> means:", opts: ["eggs", "fish", "shrimplike animals", "babies"], c: 2 },
        { q: "4. True fact:", opts: ["not good swimmers", "exactly like other birds", "wings help swim", "only mothers"], c: 2 },
        { q: "5. Only suffix underlined:", opts: ["swift<u>ly</u>", "walking", "cannot", "covered"], c: 0 },
        { q: "6. Why can't they fly?", opts: ["no wings", "weigh too much", "rather swim", "too tall"], c: 1 },
        { q: "7. NOT true about chicks:", opts: ["hatch eggs", "both parents feed", "covered feathers", "find own food now"], c: 3 }
      ]
    },
    {
      title: "Pages 9-10: Wright Brothers",
      passage: "In 1899, they began to experiment with flight. They tested kites and gliders. On December 17, 1903, Orville took the first motor-powered flight. It lasted 12 seconds.",
      qs: [
        { q: "8. Main idea?", opts: ["Testing bad", "Flyer first", "Early pilots", "Bike shop"], c: 2 },
        { q: "9. <b>Experiment</b> means:", opts: ["try new ideas", "test kites", "stay in air", "fly airplane"], c: 0 },
        { q: "10. Learning method:", opts: ["books", "others", "kites and gliders", "engines"], c: 2 },
        { q: "11. First flight duration:", opts: ["12 seconds", "1 hour", "1899", "1,000 min"], c: 0 },
        { q: "12. Opposite of <b>started</b>:", opts: ["began", "finished", "first", "continued"], c: 1 },
        { q: "13. Which is an opinion?", opts: ["Tested kites", "Flight in 1903", "Very smart", "Flyer first"], c: 2 },
        { q: "14. Prefix underlined:", opts: ["experiment", "interested", "<u>re</u>turn", "owned"], c: 2 }
      ]
    },
    {
      title: "Pages 11-12: My Shadow",
      passage: "I have a little shadow that goes in and out with me... He is very like me from the heels up to the head... The funniest thing is how he likes to grow.",
      qs: [
        { q: "1. Poem focus?", opts: ["school", "animals", "shadow relationship", "lost"], c: 2 },
        { q: "2. Feeling:", opts: ["afraid", "bored", "amused", "quiet"], c: 2 },
        { q: "3. Difference:", opts: ["grow/shrink", "jump", "find dew", "play"], c: 0 },
        { q: "4. Last stanza:", opts: ["sleep", "friend", "shadow stays home", "larger"], c: 2 },
        { q: "5. Author's purpose:", opts: ["explain", "warn", "entertain", "inform"], c: 2 },
        { q: "6. Fact:", opts: ["grows slow", "same size", "is a coward", "not like me"], c: 2 },
        { q: "7. Speaker is likely a:", opts: ["dog", "mother", "teacher", "child"], c: 3 }
      ]
    },
    {
      title: "Pages 13-14: Uncle Wilber",
      passage: "Uncle Wilber is strange. He sent Oscar the goldfish. Friday Wilber came to take Oscar home. He left a heavy box that hisses and says 'Be Careful'.",
      qs: [
        { q: "8. Friday event?", opts: ["got fish", "got letter", "picked up Oscar", "vacation"], c: 2 },
        { q: "9. Sid's feeling:", opts: ["excited", "nervous", "angry", "sad"], c: 1 },
        { q: "10. Describe Wilber:", opts: ["weird", "rude", "greedy", "selfish"], c: 0 },
        { q: "11. Why send Oscar?", opts: ["gift", "not want", "extra", "going away"], c: 3 },
        { q: "12. Opposite of <b>slowly</b>:", opts: ["carefully", "quickly", "happily", "sadly"], c: 1 },
        { q: "13. Same as <b>strange</b>:", opts: ["regular", "scary", "weird", "funny"], c: 2 }
      ]
    },
    {
      title: "Pages 16-17: Final Mastery",
      instr: "Synonyms and context clues.",
      qs: [
        { q: "1. was <u>old</u> (synonym):", opts: ["new", "ancient", "young", "dirty"], c: 1 },
        { q: "2. was <u>quiet</u> (synonym):", opts: ["loud", "silent", "noisy", "yelling"], c: 1 },
        { q: "3. was <u>thin</u> (synonym):", opts: ["narrow", "wide", "short", "tall"], c: 0 },
        { q: "4. was <u>unusual</u> (synonym):", opts: ["regular", "normal", "strange", "same"], c: 2 },
        { q: "5. family special trip (1):", opts: ["large", "clean", "special", "hard"], c: 2 },
        { q: "6. travel to beach (2):", opts: ["swim", "travel", "together", "bring"], c: 1 },
        { q: "7. learn about animals (6):", opts: ["some", "again", "long", "about"], c: 3 },
        { q: "8. finish my book (7):", opts: ["once", "enough", "yesterday", "real"], c: 1 }
      ]
    }
  ];

  const handleAnswer = (qIdx, oIdx) => {
    const key = `${currentPage}-${qIdx}`;
    if (userAnswers[key] !== undefined) return;

    setUserAnswers(prev => ({ ...prev, [key]: oIdx }));
    const isCorrect = oIdx === examData[currentPage].qs[qIdx].c;
    
    setToast({ visible: true, message: isCorrect ? 'Correct!' : 'Incorrect', isCorrect });
    setTimeout(() => setToast(prev => ({ ...prev, visible: false })), 1000);
  };

  const adjustFont = (val) => setFontSize(prev => Math.min(36, Math.max(16, prev + val)));
  const toggleTheme = () => setIsDarkMode(!isDarkMode);

  const prevPage = () => {
    if (currentPage > 0) setCurrentPage(currentPage - 1);
    window.scrollTo({ top: 0, behavior: 'smooth' });
  };

  const nextPage = () => {
    if (currentPage < examData.length - 1) setCurrentPage(currentPage + 1);
    window.scrollTo({ top: 0, behavior: 'smooth' });
  };

  const getResults = () => {
    let total = 0, correct = 0;
    examData.forEach((page, pIdx) => {
      page.qs.forEach((q, qIdx) => {
        total++;
        if (userAnswers[`${pIdx}-${qIdx}`] === q.c) correct++;
      });
    });
    return { total, correct, percent: Math.round((correct / total) * 100) };
  };

  return (
    <div className={`min-h-screen transition-colors duration-300 ${isDarkMode ? 'bg-slate-900 text-white' : 'bg-slate-50 text-slate-900'}`}>
      
      {/* Compact Header */}
      <header className={`sticky top-0 z-50 px-4 py-1.5 flex flex-col gap-0.5 shadow-md border-b ${isDarkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-200'}`}>
        <div className="flex justify-between items-center">
          <h1 className="text-base font-black text-blue-600">Merola Website</h1>
          <div className="flex items-center gap-2">
            {/* Font Control Section */}
            <div className={`flex items-center rounded-lg overflow-hidden border ${isDarkMode ? 'bg-slate-700 border-slate-600' : 'bg-slate-100 border-slate-300'}`}>
              <button onClick={() => adjustFont(-2)} className="px-3 py-1 font-black hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors">
                <Minus size={14} />
              </button>
              <div className="w-px h-3 bg-slate-300 dark:bg-slate-500" />
              <button onClick={() => adjustFont(2)} className="px-3 py-1 font-black hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors">
                <Plus size={14} />
              </button>
            </div>
            {/* Theme Toggle Button */}
            <button onClick={toggleTheme} className={`p-1.5 rounded-lg border transition-all ${isDarkMode ? 'bg-slate-700 border-slate-600' : 'bg-slate-100 border-slate-300'}`}>
              <Star size={16} className={isDarkMode ? 'text-yellow-400 fill-yellow-400' : 'text-slate-600'} />
            </button>
          </div>
        </div>
        <div className="flex justify-between items-center text-[9px] uppercase tracking-wider font-bold opacity-60">
          <span>Page {currentPage + 1} of {examData.length}</span>
          <div className="w-1/2 bg-slate-200 dark:bg-slate-700 rounded-full h-1 ml-2">
            <div className="bg-blue-600 h-1 rounded-full transition-all duration-500" style={{ width: `${((currentPage + 1) / examData.length) * 100}%` }} />
          </div>
        </div>
      </header>

      {/* Main Container */}
      <main className="w-full px-4 py-4 mb-24 max-w-full">
        {currentPage < examData.length ? (
          <div className="space-y-6">
            <div className="mb-2">
              <h2 className="font-extrabold" style={{ fontSize: fontSize * 1.1 }}>{examData[currentPage].title}</h2>
              <p className="opacity-70" style={{ fontSize: fontSize * 0.8 }}>{examData[currentPage].instr || 'Select the correct answer.'}</p>
            </div>

            {examData[currentPage].passage && (
              <div className="p-4 rounded-2xl border-l-4 border-blue-500 bg-blue-50 dark:bg-blue-900/20 shadow-sm">
                <p className="leading-relaxed" style={{ fontSize: fontSize * 1.05 }}>{examData[currentPage].passage}</p>
              </div>
            )}

            {examData[currentPage].qs.map((q, qIdx) => {
              const key = `${currentPage}-${qIdx}`;
              const answered = userAnswers[key] !== undefined;
              return (
                <div key={qIdx} className={`p-5 rounded-3xl border shadow-sm ${isDarkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-200'}`}>
                  <p className="font-bold mb-4 leading-normal font-dynamic" style={{ fontSize }} dangerouslySetInnerHTML={{ __html: q.q }} />
                  <div className="grid grid-cols-1 gap-2">
                    {q.opts.map((opt, oIdx) => {
                      let btnStyle = isDarkMode ? 'bg-slate-700 border-slate-600' : 'bg-white border-slate-200';
                      if (answered) {
                        if (oIdx === q.c) btnStyle = 'bg-green-500 border-green-500 text-white';
                        else if (oIdx === userAnswers[key]) btnStyle = 'bg-red-500 border-red-500 text-white';
                        else btnStyle += ' opacity-30';
                      }
                      return (
                        <button
                          key={oIdx}
                          onClick={() => handleAnswer(qIdx, oIdx)}
                          disabled={answered}
                          className={`w-full text-left p-4 rounded-xl font-bold border transition-all flex justify-between items-center ${btnStyle}`}
                          style={{ fontSize: fontSize * 0.9 }}
                        >
                          <span dangerouslySetInnerHTML={{ __html: opt }} />
                          {answered && oIdx === q.c && <Check size={20} />}
                          {answered && oIdx === userAnswers[key] && oIdx !== q.c && <X size={20} />}
                        </button>
                      );
                    })}
                  </div>
                </div>
              );
            })}
          </div>
        ) : null}
      </main>

      {/* Nav Footer */}
      <footer className={`fixed bottom-0 left-0 right-0 p-2 flex gap-3 z-40 border-t shadow-[0_-4px_10px_rgba(0,0,0,0.1)] ${isDarkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-200'}`}>
        <button onClick={prevPage} disabled={currentPage === 0} className="flex-1 py-2.5 bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-white rounded-xl font-black text-sm disabled:opacity-30 active:scale-95 transition-all">Back</button>
        {currentPage === examData.length - 1 ? (
          <button onClick={() => setCurrentPage(examData.length)} className="flex-1 py-2.5 bg-blue-600 text-white rounded-xl font-black text-sm shadow-lg active:scale-95 transition-all">Finish</button>
        ) : (
          <button onClick={nextPage} className="flex-1 py-2.5 bg-blue-600 text-white rounded-xl font-black text-sm shadow-lg active:scale-95 transition-all">Next</button>
        )}
      </footer>

      {/* Final Trophy View */}
      {currentPage === examData.length && (
        <div className="fixed inset-0 z-[100] flex items-center justify-center p-6 bg-blue-600 text-white overflow-y-auto">
          <div className="text-center max-w-md w-full">
            <Trophy size={100} className="mx-auto mb-6 text-yellow-300 animate-bounce" />
            <h2 className="text-4xl font-black mb-2">Well Done!</h2>
            <div className="text-8xl font-black mb-4">{getResults().percent}%</div>
            <p className="text-xl font-bold mb-10 opacity-90">Total Correct: {getResults().correct} / {getResults().total}</p>
            <button 
              onClick={() => { setCurrentPage(0); setUserAnswers({}); window.scrollTo(0, 0); }} 
              className="w-full py-5 bg-white text-blue-600 rounded-3xl font-black text-2xl shadow-2xl hover:bg-slate-100 transition-colors"
            >
              Restart Study
            </button>
          </div>
        </div>
      )}

      {/* Toast Feedback Popup */}
      <div className={`fixed top-16 left-1/2 -translate-x-1/2 px-8 py-2.5 rounded-full text-white font-black shadow-2xl transition-all duration-300 z-[100] ${toast.visible ? 'opacity-100 scale-100 translate-y-0' : 'opacity-0 scale-90 -translate-y-4 pointer-events-none'} ${toast.isCorrect ? 'bg-green-500' : 'bg-red-500'}`}>
        {toast.message}
      </div>
    </div>
  );
};

export default MerolaWebsite;

